# 섹터 기반 OR 필터 조건 가이드

## 개요

한국 주식 거래 시스템에 섹터 기반 OR 필터 조건 기능이 추가되었습니다. 이 기능은 기존의 AND 필터 로직(모든 필터 종목이 상승해야 매수)에서 OR 로직(어느 섹터든 하나의 필터 종목이 상승하면 매수 가능)으로 변경되었습니다.

## 주요 변경사항

### 1. 설정 파일 구조 변경 (kr_stocks_config.json)

**기존 구조 (AND 로직)**:
```json
{
    "filter_stocks": {
        "005930": true,
        "000660": true,
        "035420": true
    },
    "watch_list": ["035720", "247540", "293490", ...]
}
```

**새로운 구조 (섹터 기반 OR 로직)**:
```json
{
    "sectors": {
        "semiconductor": {
            "name": "반도체",
            "filter_stocks": {
                "005930": true,  // 삼성전자
                "000660": true   // SK하이닉스
            },
            "watch_list": ["247540", "012330", "066570", "034020"]
        },
        "internet_platform": {
            "name": "인터넷/플랫폼",
            "filter_stocks": {
                "035420": true,  // 네이버
                "035720": true   // 카카오
            },
            "watch_list": ["035720", "035420", "293490", "017670"]
        },
        ...
    }
}
```

### 2. 필터 로직 변경

#### 기존 AND 로직:
- **모든** 필터 종목이 상승해야만 매수 가능
- 하나라도 하락하면 매수 불가

#### 새로운 OR 로직:
- **섹터 내부**: 각 섹터의 필터 종목 중 **하나라도** 상승하면 해당 섹터 통과
- **섹터 간**: **하나의 섹터라도** 통과하면 매수 허용
- 통과한 섹터의 watch_list 종목만 매수 대상

## 섹터 구성

현재 5개 섹터로 구성되어 있습니다:

| 섹터 | 필터 종목 | 감시 종목 |
|------|-----------|-----------|
| 반도체 | 삼성전자(005930), SK하이닉스(000660) | 4종목 |
| 인터넷/플랫폼 | 네이버(035420), 카카오(035720) | 4종목 |
| 자동차/배터리 | 현대차(005380), LG화학(051910) | 4종목 |
| 금융 | KB금융(105560), 신한지주(055550) | 3종목 |
| 바이오 | 삼성바이오로직스(207940), 셀트리온(068270) | 4종목 |

## 동작 예시

### 시나리오 1: 반도체 섹터만 통과

**상황**:
- 반도체 섹터: 삼성전자(하락), **SK하이닉스(상승)** → 섹터 통과 ✓
- 인터넷/플랫폼 섹터: 네이버(하락), 카카오(하락) → 섹터 미통과 ✗
- 자동차/배터리 섹터: 현대차(하락), LG화학(하락) → 섹터 미통과 ✗
- 금융 섹터: KB금융(하락), 신한지주(하락) → 섹터 미통과 ✗
- 바이오 섹터: 삼성바이오(하락), 셀트리온(하락) → 섹터 미통과 ✗

**결과**:
- 매수 허용: 예
- 매수 대상: 반도체 섹터의 watch_list 종목만 (247540, 012330, 066570, 034020)

### 시나리오 2: 여러 섹터 통과

**상황**:
- 반도체 섹터: **삼성전자(상승)**, SK하이닉스(하락) → 섹터 통과 ✓
- 인터넷/플랫폼 섹터: 네이버(하락), **카카오(상승)** → 섹터 통과 ✓
- 자동차/배터리 섹터: 현대차(하락), LG화학(하락) → 섹터 미통과 ✗
- 금융 섹터: KB금융(하락), 신한지주(하락) → 섹터 미통과 ✗
- 바이오 섹터: 삼성바이오(하락), 셀트리온(하락) → 섹터 미통과 ✗

**결과**:
- 매수 허용: 예
- 매수 대상: 반도체 + 인터넷/플랫폼 섹터의 watch_list 종목 (총 8종목)

### 시나리오 3: 모든 섹터 미통과

**상황**:
- 모든 섹터의 필터 종목이 전부 하락

**결과**:
- 매수 허용: 아니오
- 매수 대상: 없음

## 하위 호환성

기존의 flat 구조(filter_stocks, watch_list) 설정 파일도 계속 지원됩니다:

```json
{
    "filter_stocks": {
        "005930": true,
        "000660": true
    },
    "watch_list": ["035720", "247540", ...]
}
```

이 경우 기존의 AND 로직으로 동작합니다.

## 코드 변경사항

### 1. kr_stocks_config.json
- 5개 섹터 구조로 재구성
- 각 섹터별 filter_stocks와 watch_list 분리

### 2. common/base_strategy.py
- `get_sectors()`: 섹터 구조 반환 메서드 추가
- `_check_sector_filter_condition()`: 섹터별 OR 필터 로직 구현
- `get_passing_sectors()`: 통과한 섹터 정보 반환
- `check_filter_condition()`: 섹터 구조 감지 및 적절한 로직 선택

### 3. kr/strategy.py
- `_load_stock_config()`: 섹터 구조 파싱 추가
- `get_sectors()`: 오버라이드하여 섹터 정보 반환
- `_get_active_watch_list()`: 통과한 섹터의 watch_list만 반환
- `get_top_declining_stocks()`: 오버라이드하여 활성 watch_list 사용

## 테스트

테스트 스크립트를 실행하여 동작을 검증할 수 있습니다:

```bash
python test_sector_filter.py
```

**테스트 결과**:
- ✓ 섹터 구조 로드
- ✓ 하위 호환성
- ✓ OR 로직 검증
- ✓ 설정 파일 유효성

## 사용 방법

1. **설정 파일 확인**: `kr_stocks_config.json`이 섹터 구조로 되어 있는지 확인
2. **전략 실행**: 기존과 동일하게 `KRStrategy` 사용
3. **로그 확인**: 로그에서 섹터별 필터 통과 여부 확인

```python
from kr.strategy import KRStrategy

strategy = KRStrategy(enable_filter_check=True)

# 매수 전략 실행 (섹터 OR 필터 자동 적용)
result = strategy.execute_buy_strategy()
```

## 로그 예시

```
INFO - KR 설정 로드 (섹터 모드): 5개 섹터
INFO -   - 반도체: filter=2종목, watch=4종목
INFO -   - 인터넷/플랫폼: filter=2종목, watch=4종목
INFO -   - 자동차/배터리: filter=2종목, watch=4종목
INFO -   - 금융: filter=2종목, watch=3종목
INFO -   - 바이오: filter=2종목, watch=4종목
INFO - ✓ 섹터 반도체 통과: 1개 종목 상승 중
INFO - ✗ 섹터 인터넷/플랫폼 미통과: 모든 필터 종목 하락/보합
INFO - 필터 조건 충족 - 1개 섹터 통과
INFO - 활성 watch_list: 4종목 (통과 섹터 1개)
```

## 주의사항

1. **섹터 설정**: 각 섹터에 최소 1개 이상의 filter_stocks와 watch_list가 필요합니다.
2. **성능**: 섹터가 많을수록 API 호출이 증가할 수 있으므로 적절한 섹터 수를 유지하세요.
3. **백업**: 설정 파일을 변경하기 전에 백업을 권장합니다.

## 문제 해결

### 섹터가 로드되지 않는 경우
- `kr_stocks_config.json` 파일에 `"sectors"` 키가 있는지 확인
- JSON 문법 오류가 없는지 확인

### 필터가 작동하지 않는 경우
- `enable_filter_check=True`로 설정되어 있는지 확인
- 로그에서 "필터 체크 비활성화됨" 메시지가 있는지 확인

### 매수 대상 종목이 없는 경우
- 로그에서 어떤 섹터가 통과했는지 확인
- 통과한 섹터의 watch_list에 종목이 있는지 확인
