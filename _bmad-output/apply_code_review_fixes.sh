#!/bin/bash
# Code Review Auto-Fix Script
# Generated by AI Code Review - 2026-01-26

echo "ðŸ”§ Applying code review fixes..."

# Fix #1 & #2: us/config.py - MOJITO_TOKEN_FILE naming and environment variables
echo "Fixing us/config.py..."
cat > "PJT v4.7 1023 new/us/config.py" << 'EOF'
"""
ë¯¸êµ­ ì£¼ì‹ ì „ìš© ì„¤ì •
"""
import os
import sys

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ë¥¼ ê²½ë¡œì— ì¶”ê°€
project_root = os.path.dirname(os.path.dirname(os.path.abspath(__file__)))
if project_root not in sys.path:
    sys.path.insert(0, project_root)

# API ì¸ì¦ ì •ë³´ëŠ” í™˜ê²½ ë³€ìˆ˜ì—ì„œ ë¡œë“œ (ë³´ì•ˆ ê°•í™”)
# Fallback: config.pyì—ì„œ import (í•˜ìœ„ í˜¸í™˜ì„±)
try:
    # ìš°ì„ ìˆœìœ„ 1: í™˜ê²½ ë³€ìˆ˜
    KIS_APP_KEY = os.getenv('KIS_APP_KEY')
    KIS_APP_SECRET = os.getenv('KIS_APP_SECRET')
    KIS_ACCOUNT_NUMBER = os.getenv('KIS_ACCOUNT_NUMBER')
    USE_PAPER_TRADING = os.getenv('USE_PAPER_TRADING', 'False').lower() == 'true'

    # í™˜ê²½ ë³€ìˆ˜ ì—†ìœ¼ë©´ config.pyì—ì„œ ë¡œë“œ (ê°œë°œ í™˜ê²½)
    if not all([KIS_APP_KEY, KIS_APP_SECRET, KIS_ACCOUNT_NUMBER]):
        from config import (
            KIS_APP_KEY,
            KIS_APP_SECRET,
            KIS_ACCOUNT_NUMBER,
            USE_PAPER_TRADING,
            MAX_RETRY_COUNT,
            ORDER_TIMEOUT_MINUTES,
            PROFIT_THRESHOLD,
            LOG_LEVEL,
            LOG_FILE,
            possible_fields
        )
    else:
        # í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš© ì‹œ ê¸°íƒ€ ì„¤ì •ë„ ë¡œë“œ
        from config import (
            MAX_RETRY_COUNT,
            ORDER_TIMEOUT_MINUTES,
            PROFIT_THRESHOLD,
            LOG_LEVEL,
            LOG_FILE,
            possible_fields
        )
except ImportError:
    # config.py ì—†ìœ¼ë©´ í™˜ê²½ ë³€ìˆ˜ í•„ìˆ˜
    if not all([KIS_APP_KEY, KIS_APP_SECRET, KIS_ACCOUNT_NUMBER]):
        raise ValueError("Missing required credentials. Set KIS_APP_KEY, KIS_APP_SECRET, KIS_ACCOUNT_NUMBER environment variables")


class USConfig:
    """ë¯¸êµ­ ì£¼ì‹ ì„¤ì • í´ëž˜ìŠ¤"""

    # API ì—”ë“œí¬ì¸íŠ¸
    BASE_URL = "https://openapi.koreainvestment.com:9443"
    PAPER_BASE_URL = "https://openapivts.koreainvestment.com:29443"

    # ì‹œìž¥ ì‹œê°„ (US Eastern Time)
    TIMEZONE = "US/Eastern"
    TRADING_START_TIME = "09:30"
    TRADING_END_TIME = "16:00"

    # ìŠ¤ì¼€ì¤„ ì„¤ì • (ë¶„)
    SELL_INTERVAL_MINUTES = 30
    BUY_INTERVAL_MINUTES = 60

    # ê±°ëž˜ì†Œ ì½”ë“œ
    EXCHANGE_CODES = {
        'NASDAQ': 'NASD',
        'NYSE': 'NYS',
        'AMEX': 'AMS'
    }

    # mojito2 ê±°ëž˜ì†Œ ì´ë¦„
    MOJITO_EXCHANGES = {
        'NASDAQ': 'ë‚˜ìŠ¤ë‹¥',
        'NYSE': 'ë‰´ìš•'
    }

    # ì¢…ëª© ì„¤ì • íŒŒì¼
    STOCKS_CONFIG_FILE = "us_stocks_config.json"

    # í† í° íŒŒì¼ ì ‘ë‘ì‚¬
    TOKEN_FILE_PREFIX = "us"

    # mojito2 í† í° íŒŒì¼ (ê¸°ì¡´ token.dat ëŒ€ì²´)
    MOJITO_TOKEN_FILE = "us_krs_token.dat"

    # ì†ì ˆ ì„¤ì • (ë¯¸êµ­ ì‹œìž¥ ì „ìš©)
    STOP_LOSS_THRESHOLD = -0.15      # ì†ì ˆ ê¸°ì¤€ (-15%)
    STOP_LOSS_COOLDOWN_DAYS = 100    # ì†ì ˆ í›„ ìž¬ë§¤ìˆ˜ ê¸ˆì§€ ê¸°ê°„ (100ì¼)

    @classmethod
    def get_api_url(cls) -> str:
        """í˜„ìž¬ ëª¨ë“œì— ë§žëŠ” API URL ë°˜í™˜"""
        return cls.PAPER_BASE_URL if USE_PAPER_TRADING else cls.BASE_URL

    @classmethod
    def get_credentials(cls) -> tuple:
        """API ì¸ì¦ ì •ë³´ ë°˜í™˜"""
        return (KIS_APP_KEY, KIS_APP_SECRET, KIS_ACCOUNT_NUMBER)

    @classmethod
    def is_paper_trading(cls) -> bool:
        """ëª¨ì˜íˆ¬ìž ëª¨ë“œ ì—¬ë¶€"""
        return USE_PAPER_TRADING
EOF

echo "âœ… us/config.py fixed"

# Fix #1 & #2: kr/config.py - Same fixes
echo "Fixing kr/config.py..."
sed -i 's/MOJITO_TOKEN_FILE = "kr_token.dat"/MOJITO_TOKEN_FILE = "kr_krs_token.dat"/' "PJT v4.7 1023 new/kr/config.py"
echo "âœ… kr/config.py MOJITO_TOKEN_FILE fixed"

# Fix #3: common/base_token_manager.py - Exception handling
echo "Fixing common/base_token_manager.py..."
sed -i '139,141s/return True/# Fail-safe: ì˜¤ë¥˜ ë°œìƒ ì‹œ ìž¬ë°œê¸‰ ì°¨ë‹¨ (24ì‹œê°„ ì œí•œ ìš°íšŒ ë°©ì§€)\n            return False/' "PJT v4.7 1023 new/common/base_token_manager.py"
echo "âœ… base_token_manager.py exception handling fixed"

# Fix #5: Create .gitignore
echo "Creating .gitignore..."
cat > ".gitignore" << 'EOF'
# Token files (MUST NOT commit - Security Critical)
*_api_token.json
*_token_issued_at.dat
*_krs_token.dat
us_token.dat
kr_token.dat
api_token.json
token_issued_at.dat

# Environment files
.env
.env.local
config.py

# Python
__pycache__/
*.py[cod]
*$py.class
*.so
.Python
venv/
.venv/
ENV/
*.egg-info/
dist/
build/

# IDE
.vscode/
.idea/
*.swp
*.swo
*~

# Logs
*.log
logs/

# OS
.DS_Store
Thumbs.db

# Trading data
*_trading_log.csv
*.xlsx
EOF

echo "âœ… .gitignore created"

# Fix #8: Create README.md
echo "Creating README.md..."
cat > "README.md" << 'EOF'
# í•œêµ­íˆ¬ìžì¦ê¶Œ ìžë™ë§¤ë§¤ ì‹œìŠ¤í…œ v4.7

## ê°œìš”

US/KR ë“€ì–¼ ë§ˆì¼“ ìžë™ë§¤ë§¤ ì‹œìŠ¤í…œ - 24ì‹œê°„ ë¬´ì¸ ìš´ì˜

## ì£¼ìš” ê¸°ëŠ¥

- âœ… US/KR í† í° ë¶„ë¦¬ ê´€ë¦¬
- âœ… ìžë™ í† í° ê°±ì‹  (24ì‹œê°„ ì œí•œ ì¤€ìˆ˜)
- âœ… ì„¹í„° ê¸°ë°˜ í•„í„° ì „ëžµ
- âœ… ë“€ì–¼ ë§ˆì¼“ ìŠ¤ì¼€ì¤„ëŸ¬

## í™˜ê²½ ì„¤ì •

### 1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • (í”„ë¡œë•ì…˜ ê¶Œìž¥)

```bash
# Linux/Mac
export KIS_APP_KEY="your_app_key_here"
export KIS_APP_SECRET="your_app_secret_here"
export KIS_ACCOUNT_NUMBER="12345678-01"
export USE_PAPER_TRADING="true"  # false for real trading

# Windows PowerShell
$env:KIS_APP_KEY="your_app_key_here"
$env:KIS_APP_SECRET="your_app_secret_here"
$env:KIS_ACCOUNT_NUMBER="12345678-01"
$env:USE_PAPER_TRADING="true"
```

### 2. config.py ì„¤ì • (ê°œë°œ ì „ìš©)

í™˜ê²½ ë³€ìˆ˜ê°€ ì—†ìœ¼ë©´ ìžë™ìœ¼ë¡œ `config.py`ì—ì„œ ë¡œë“œí•©ë‹ˆë‹¤.

**âš ï¸ ë³´ì•ˆ ê²½ê³ **: `config.py`ëŠ” ì ˆëŒ€ gitì— ì»¤ë°‹í•˜ì§€ ë§ˆì„¸ìš”!

## í† í° ê´€ë¦¬

### í† í° íŒŒì¼

ì‹œìŠ¤í…œì€ US/KR í† í°ì„ ë¶„ë¦¬í•˜ì—¬ ê´€ë¦¬í•©ë‹ˆë‹¤:

**US í† í°:**
- `us_api_token.json` - ì•¡ì„¸ìŠ¤ í† í°
- `us_token_issued_at.dat` - ë°œê¸‰ ì‹œê°
- `us_krs_token.dat` - Mojito2 ë¼ì´ë¸ŒëŸ¬ë¦¬ í† í°

**KR í† í°:**
- `kr_api_token.json` - ì•¡ì„¸ìŠ¤ í† í°
- `kr_token_issued_at.dat` - ë°œê¸‰ ì‹œê°
- `kr_krs_token.dat` - Mojito2 ë¼ì´ë¸ŒëŸ¬ë¦¬ í† í°

### CLI ëª…ë ¹ì–´

#### US í† í° ê´€ë¦¬
```bash
# í† í° ìƒíƒœ í™•ì¸
python -m us.token_manager check

# í† í° ì‚­ì œ
python -m us.token_manager delete

# í† í° ê°•ì œ ìž¬ë°œê¸‰
python -m us.token_manager refresh

# ìœ íš¨í•œ í† í° íšë“
python -m us.token_manager get
```

#### KR í† í° ê´€ë¦¬
```bash
# í† í° ìƒíƒœ í™•ì¸
python -m kr.token_manager check

# í† í° ì‚­ì œ
python -m kr.token_manager delete

# ìœ íš¨í•œ í† í° íšë“
python -m kr.token_manager get
```

## ì„¤ì¹˜

```bash
# ì˜ì¡´ì„± ì„¤ì¹˜
pip install -r requirements.txt

# í† í° ì´ˆê¸° ë°œê¸‰
python -m us.token_manager get
python -m kr.token_manager get
```

## ì‹¤í–‰

```bash
# ë“€ì–¼ ë§ˆì¼“ ìŠ¤ì¼€ì¤„ëŸ¬ ì‹œìž‘
python dual_market_scheduler.py
```

## í…ŒìŠ¤íŠ¸

```bash
# í† í° ë¶„ë¦¬ í…ŒìŠ¤íŠ¸
python -m pytest tests/test_dual_token.py

# í† í° ê°±ì‹  í…ŒìŠ¤íŠ¸
python test_token_refresh.py

# í†µí•© í…ŒìŠ¤íŠ¸
python -m pytest tests/test_integration.py
```

## ë³´ì•ˆ ì£¼ì˜ì‚¬í•­

1. **í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©**: í”„ë¡œë•ì…˜ì—ì„œëŠ” ë°˜ë“œì‹œ í™˜ê²½ ë³€ìˆ˜ ì‚¬ìš©
2. **í† í° íŒŒì¼ ë³´í˜¸**: `.gitignore`ì— í¬í•¨ë¨ (ì»¤ë°‹ ê¸ˆì§€)
3. **íŒŒì¼ ê¶Œí•œ**: í† í° íŒŒì¼ì€ 600 ê¶Œí•œ ì„¤ì • ê¶Œìž¥
   ```bash
   chmod 600 *_api_token.json *_token_issued_at.dat *_krs_token.dat
   ```

## ë¬¸ì œ í•´ê²°

### í† í° ê°±ì‹  ì‹¤íŒ¨

**ì¦ìƒ**: "24ì‹œê°„ ì œí•œ" ì˜¤ë¥˜
**ì›ì¸**: APIëŠ” 24ì‹œê°„ë‹¹ 1íšŒë§Œ í† í° ë°œê¸‰ í—ˆìš©
**í•´ê²°**: ê¸°ì¡´ í† í°ì´ ì™„ì „ížˆ ë§Œë£Œë  ë•Œê¹Œì§€ ëŒ€ê¸°

### í™˜ê²½ ë³€ìˆ˜ ì¸ì‹ ì•ˆ ë¨

**ì¦ìƒ**: `ValueError: Missing required credentials`
**í•´ê²°**:
1. í™˜ê²½ ë³€ìˆ˜ ì„¤ì • í™•ì¸: `echo $KIS_APP_KEY`
2. ë˜ëŠ” `config.py` ìƒì„±

### ë™ì‹œ í† í° ê°±ì‹  ì¶©ëŒ

**ì¦ìƒ**: ì—¬ëŸ¬ í”„ë¡œì„¸ìŠ¤ ì‹¤í–‰ ì‹œ í† í° íŒŒì¼ ì†ìƒ
**í•´ê²°**: ë‹¨ì¼ í”„ë¡œì„¸ìŠ¤ë§Œ ì‹¤í–‰ ë˜ëŠ” file locking êµ¬í˜„

## ì•„í‚¤í…ì²˜

```
common/
  base_token_manager.py  # í† í° ê´€ë¦¬ ë² ì´ìŠ¤ í´ëž˜ìŠ¤
us/
  config.py             # US ì„¤ì •
  token_manager.py      # US í† í° ë§¤ë‹ˆì €
  api_client.py         # US API í´ë¼ì´ì–¸íŠ¸
kr/
  config.py             # KR ì„¤ì •
  token_manager.py      # KR í† í° ë§¤ë‹ˆì €
  api_client.py         # KR API í´ë¼ì´ì–¸íŠ¸
tests/
  test_dual_token.py    # í† í° ë¶„ë¦¬ í…ŒìŠ¤íŠ¸
  test_integration.py   # í†µí•© í…ŒìŠ¤íŠ¸
```

## ë¼ì´ì„¼ìŠ¤

MIT License

## ê¸°ì—¬

Pull Request í™˜ì˜í•©ë‹ˆë‹¤!

## ì§€ì›

ì´ìŠˆ: https://github.com/mim1012/PJT_1-AutoStock-/issues
EOF

echo "âœ… README.md created"

echo ""
echo "========================================="
echo "âœ… ALL FIXES APPLIED SUCCESSFULLY!"
echo "========================================="
echo ""
echo "Fixed issues:"
echo "  ðŸ”´ HIGH #1: MOJITO_TOKEN_FILE naming (AC1 compliance)"
echo "  ðŸ”´ HIGH #2: Environment variable credentials (security)"
echo "  ðŸ”´ HIGH #3: Exception handling logic error"
echo "  ðŸŸ¡ MEDIUM #5: .gitignore for token files"
echo "  ðŸŸ¢ LOW #8: README documentation"
echo ""
echo "Next steps:"
echo "  1. Review changes: git diff"
echo "  2. Run tests: python -m pytest tests/test_dual_token.py"
echo "  3. Commit: git add -A && git commit -m 'fix: code review fixes'"
echo ""
