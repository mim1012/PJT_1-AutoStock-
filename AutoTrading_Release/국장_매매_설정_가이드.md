# 한국 주식(국장) 매매 설정 가이드

이 문서는 한국 주식 자동매매 시스템의 핵심 설정 방법을 상세히 설명합니다.

## 📋 목차

1. [시작 전 설정 확인](#1-시작-전-설정-확인) ⭐NEW
2. [종목 설정](#2-종목-설정)
3. [손절 설정](#3-손절-설정)
4. [매수 조건](#4-매수-조건)
5. [매도 조건](#5-매도-조건)
6. [자주 묻는 질문](#6-자주-묻는-질문)

---

## 1. 시작 전 설정 확인 ⭐NEW

### 1-1. 자동 설정 검증 시스템

시스템을 시작하면 **장 시작 전에** 자동으로 다음을 확인합니다:

✅ **국장 설정 표시**
- 거래 모드 (모의투자/실전투자)
- 손절률 및 재매수 금지 기간
- 필터 종목 목록 및 유효성
- 감시 종목 목록 및 유효성

✅ **미장 설정 표시**
- 거래 모드 (모의투자/실전투자)
- 손절률 및 재매수 금지 기간
- 거래 종목 목록 및 유효성

✅ **종목 코드 검증**
- 존재하지 않는 종목 코드 감지
- 잘못된 형식 감지

### 1-2. 시작 화면 예시

```
================================================================================
🚀 한국투자증권 자동매매 시스템 v4.7
================================================================================
시작 시간: 2026-01-31 08:45:00
================================================================================

🔍 한국 주식 종목 검증 중...

================================================================================
🇰🇷 한국 주식 (국장) 설정
================================================================================
📌 거래 모드: 모의투자
📌 손절률: -10.0%
📌 재매수 금지: 50일
📌 목표 수익률: 5.0%

[필터 종목] - 이 종목들이 모두 상승해야 매수 실행
--------------------------------------------------------------------------------
✅ 005930: 확인됨
✅ 000660: 확인됨
✅ 035420: 확인됨

[감시 종목] - 실제 매수 후보 (하락률 상위 3개 매수)
--------------------------------------------------------------------------------
✅  1. 035720: 확인됨
✅  2. 247540: 확인됨
✅  3. 293490: 확인됨
... (생략)
================================================================================

🔍 미국 주식 종목 검증 중...

================================================================================
🇺🇸 미국 주식 (미장) 설정
================================================================================
📌 거래 모드: 모의투자
📌 손절률: -15.0%
📌 재매수 금지: 3일
📌 목표 수익률: 5.0%

[거래 종목]
--------------------------------------------------------------------------------
✅  1. AAPL   (NASDAQ): 확인됨
✅  2. TSLA   (NASDAQ): 확인됨
✅  3. MSFT   (NASDAQ): 확인됨
================================================================================

✅ 모든 설정이 정상입니다.

자동매매를 시작하시겠습니까?
  - Enter: 시작
  - q: 종료
================================================================================

입력:
```

### 1-3. 오류 발견 시

종목 코드 오류가 있으면 다음과 같이 표시됩니다:

```
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
❌ 오류 발견:
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
  - [국장 필터] 005931: 종목 조회 실패 (존재하지 않거나 API 오류)
  - [국장 감시] 99999: 잘못된 형식 (6자리 숫자 필요)
  - [미장] AAPL1 (NASDAQ): 잘못된 형식 (대문자 1-5자리)
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!

❌ 오류가 발견되었습니다.

계속 진행하시겠습니까?
  - Enter: 계속 진행 (위험할 수 있음)
  - q: 종료 후 설정 수정
================================================================================

입력:
```

**권장**: `q`를 입력하여 종료한 후, 설정 파일을 수정하세요!

### 1-4. 설정 확인 건너뛰기

**불가능합니다!** 시스템 시작 시 항상 설정 확인을 거쳐야 합니다.

이는 다음을 방지하기 위함입니다:
- 잘못된 종목 코드로 인한 오류
- 예상치 못한 종목 거래
- 설정 실수로 인한 손실

---

## 2. 종목 설정

### 2-1. 설정 파일 위치

`kr_stocks_config.json` 파일에서 거래할 종목을 설정합니다.

### 2-2. 설정 구조

```json
{
    "filter_stocks": {
        "005930": true,
        "000660": true,
        "035420": true
    },
    "watch_list": [
        "035720", "247540", "293490", "068270", "028260",
        "009830", "086520", "012330", "066570", "017670",
        "034020", "003670", "015760"
    ]
}
```

### 2-3. 용어 설명

#### filter_stocks (필터 종목)
- **역할**: 시장 상승 여부를 판단하는 **지표 종목**
- **조건**: 이 종목들이 전일 대비 상승 중일 때만 매수 실행
- **추천**: 대형주나 시장을 대표하는 종목 (삼성전자, SK하이닉스 등)
- **예시**:
  - `"005930": true` → 삼성전자
  - `"000660": true` → SK하이닉스
  - `"035420": true` → NAVER

**중요**: filter_stocks가 **모두 상승** 중이어야 매수가 실행됩니다!

#### watch_list (감시 종목)
- **역할**: 실제로 매수할 **후보 종목** 리스트
- **조건**: 이 중에서 하락률 상위 3개 종목을 매수
- **추천**: 성장성 있는 중소형주 또는 관심 종목
- **예시**:
  - `"035720"` → 카카오
  - `"247540"` → 에코프로비엠
  - `"293490"` → 카카오게임즈

### 2-4. 종목 코드 찾기

1. [한국거래소 사이트](http://data.krx.co.kr/) 접속
2. 종목 검색
3. 6자리 종목 코드 확인
4. JSON 파일에 **문자열로** 입력 (따옴표 필수!)

### 2-5. 종목 추가/삭제 방법

#### filter_stocks에 종목 추가
```json
"filter_stocks": {
    "005930": true,
    "000660": true,
    "035420": true,
    "051910": true    // ← LG화학 추가
}
```

#### watch_list에 종목 추가/삭제
```json
"watch_list": [
    "035720",
    "247540",
    "293490",  // ← 여기 쉼표 주의!
    "373220"   // ← LG에너지솔루션 추가
]
```

**주의사항**:
- 마지막 항목에는 쉼표를 붙이지 마세요
- 종목 코드는 반드시 **6자리** 숫자여야 합니다
- 따옴표(`"`) 안에 작성해야 합니다

---

## 2. 손절 설정

### 2-1. 설정 파일 위치

`kr/config.py` 파일 (78-79줄)

### 2-2. 현재 기본값

```python
# 손절 설정 (한국 시장 전용)
STOP_LOSS_THRESHOLD = -0.10      # 손절 기준 (-10%)
STOP_LOSS_COOLDOWN_DAYS = 50     # 손절 후 재매수 금지 기간 (50일)
```

### 2-3. 설정 변경 방법

#### 손절 % 변경

손절 기준을 **-15%**로 변경하려면:

```python
STOP_LOSS_THRESHOLD = -0.15      # -15%로 변경
```

**손절률 계산식**:
- -10% → `-0.10`
- -15% → `-0.15`
- -20% → `-0.20`

#### 재매수 금지 기간 변경

손절 후 **30일 동안** 재매수를 금지하려면:

```python
STOP_LOSS_COOLDOWN_DAYS = 30     # 30일로 변경
```

### 2-4. 손절 작동 예시

**시나리오**:
1. 삼성전자(005930)를 70,000원에 매수
2. 현재가 63,000원 (수익률: -10%)
3. 손절 기준(-10%) 도달 → 자동 매도
4. 손절 블랙리스트에 등록 → 50일 동안 재매수 불가

**로그 메시지**:
```
[INFO] 005930: 손절 조건 충족 (-10.00%)
[INFO] 매도 주문 실행: 005930 (손절매)
[INFO] 005930를 블랙리스트에 추가 (50일 재매수 금지)
```

### 2-5. 블랙리스트 확인

손절로 인한 재매수 금지 종목은 다음 파일에서 확인:

```
kr_stop_loss_blacklist.json
```

**파일 내용 예시**:
```json
{
    "005930": {
        "added_date": "2026-01-27",
        "expire_date": "2026-03-18",
        "avg_price": 70000,
        "loss_price": 63000,
        "loss_rate": -0.10
    }
}
```

**블랙리스트 수동 해제 방법**:
- 해당 종목 항목을 JSON 파일에서 삭제
- 또는 `expire_date`를 과거 날짜로 변경

---

## 3. 매수 조건

### 3-1. 매수 조건 체크리스트

시스템은 다음 **모든 조건**이 충족될 때만 매수를 실행합니다:

- [ ] **시장 오픈 확인**: 한국 시장 거래 시간 (09:00 - 15:30 KST)
- [ ] **필터 조건 통과**: filter_stocks의 **모든 종목**이 전일 대비 상승 중
- [ ] **예수금 확인**: 매수 가능한 잔고가 있어야 함
- [ ] **하락률 상위**: watch_list에서 하락률 상위 3개 종목 선정
- [ ] **블랙리스트 체크**: 손절 후 재매수 금지 기간이 아니어야 함
- [ ] **이전 매도가 체크**: 현재가가 이전 매도가보다 낮아야 함

### 3-2. 매수 조건 상세 설명

#### 조건 1: 필터 조건 (filter_stocks)

**목적**: 시장이 상승 추세일 때만 매수

**작동 방식**:
```
filter_stocks = ["005930", "000660", "035420"]

1. 005930 (삼성전자) 현재가 체크
   - 전일 종가: 70,000원
   - 현재가: 71,000원
   - 결과: ✅ 상승 중 (1.43%)

2. 000660 (SK하이닉스) 현재가 체크
   - 전일 종가: 140,000원
   - 현재가: 139,000원
   - 결과: ❌ 하락 중 (-0.71%)

→ 필터 조건 미충족 (모든 종목이 상승해야 함)
→ 매수 실행 안 함
```

**로그 메시지**:
```
[INFO] 필터 조건 미충족: 000660 하락 중 (현재: 139000, 전일: 140000)
[INFO] 필터 조건 미충족 → 매수 건너뜀
```

#### 조건 2: 하락률 상위 종목 선정

**목적**: 단기 과매도된 종목에 저점 매수

**작동 방식**:
```
watch_list의 각 종목 하락률 계산:

035720 (카카오): -3.5%
247540 (에코프로비엠): -5.2%
293490 (카카오게임즈): -2.1%
068270 (셀트리온): -4.8%
...

→ 하락률 상위 3개 선정:
1. 247540 (-5.2%)
2. 068270 (-4.8%)
3. 035720 (-3.5%)
```

#### 조건 3: 블랙리스트 체크

**목적**: 손절한 종목은 일정 기간 재매수 금지

**작동 방식**:
```
매수 시도: 247540 (에코프로비엠)

블랙리스트 확인:
- 247540가 kr_stop_loss_blacklist.json에 있음
- 추가일: 2026-01-10
- 만료일: 2026-03-01
- 현재일: 2026-01-27
- 남은 기간: 33일

→ 매수 불가
```

**로그 메시지**:
```
[INFO] 247540: 손절 후 재매수 금지 중 (남은 기간: 33일)
```

#### 조건 4: 이전 매도가 체크

**목적**: 같은 가격대에서 반복 매매 방지

**작동 방식**:
```
매수 시도: 035720 (카카오)
현재가: 58,000원

이전 매도 기록 확인:
- 마지막 매도가: 57,500원
- 현재가(58,000) > 매도가(57,500)

→ 매수 불가 (더 떨어질 때까지 대기)
```

**로그 메시지**:
```
[INFO] 035720: 현재가 58,000원이 이전 매도가보다 높음 → 매수 불가
```

### 3-3. 매수 실행 예시

**성공 케이스**:
```
[INFO] === 한국 주식 매수 전략 실행 ===
[INFO] 필터 조건 충족 - 모든 필터 종목 상승 중
[INFO] 하락률 상위 종목:
  1. 068270 (-4.8%) - 블랙리스트 없음, 매도가 체크 통과
  2. 035720 (-3.5%) - 블랙리스트 없음, 매도가 체크 통과
  3. 293490 (-2.1%) - 블랙리스트 있음 (건너뜀)
[INFO] 매수 주문 실행: 068270 100주 @ 185,000원
[INFO] 매수 주문 실행: 035720 50주 @ 58,000원
[INFO] 2건 매수 실행
```

---

## 4. 매도 조건

### 4-1. 매도 조건 (2가지)

#### 조건 1: 익절 (목표 수익률 달성)

**설정 위치**: `config.py` 파일 (33줄)

```python
PROFIT_THRESHOLD = 0.05  # 목표 수익률 5%
```

**작동 방식**:
```
보유 종목: 005930 (삼성전자)
매수 평균가: 70,000원
현재가: 73,500원
수익률: +5.0%

→ 목표 수익률 도달 → 자동 매도
```

#### 조건 2: 손절 (손실 한도 초과)

**설정 위치**: `kr/config.py` 파일 (78줄)

```python
STOP_LOSS_THRESHOLD = -0.10  # 손절 기준 -10%
```

**작동 방식**:
```
보유 종목: 000660 (SK하이닉스)
매수 평균가: 140,000원
현재가: 126,000원
수익률: -10.0%

→ 손절 기준 도달 → 자동 매도 + 블랙리스트 등록
```

### 4-2. 매도 우선순위

매도 체크 시 **수익률 높은 순**으로 처리:

```
보유 종목:
1. 005930: +5.2% → 익절
2. 035720: +2.1% → 유지
3. 000660: -10.5% → 손절
4. 068270: -3.2% → 유지

→ 매도 실행: 005930 (익절), 000660 (손절)
```

---

## 5. 자주 묻는 질문

### Q1. filter_stocks와 watch_list의 차이가 뭔가요?

**답변**:
- **filter_stocks**: 시장 상태를 판단하는 지표 (이 종목들이 올라야 매수 허용)
- **watch_list**: 실제로 매수할 후보 종목 (이 중에서 하락률 상위 매수)

**예시**:
```
filter_stocks = ["005930", "000660"]  ← 대형주 (시장 지표)
watch_list = ["035720", "247540", ...]  ← 중소형주 (매수 대상)

매수 로직:
1. filter_stocks가 모두 상승 중인가? → YES
2. watch_list에서 하락률 상위 3개 선정
3. 선정된 종목 매수
```

### Q2. 손절 후 재매수 금지를 해제하려면?

**방법 1**: 블랙리스트 파일 수정

`kr_stop_loss_blacklist.json` 파일에서 해당 종목 삭제

**방법 2**: 만료일 변경

```json
{
    "005930": {
        "expire_date": "2026-01-01"  ← 과거 날짜로 변경
    }
}
```

**방법 3**: 쿨다운 기간 단축

`kr/config.py` 파일에서:
```python
STOP_LOSS_COOLDOWN_DAYS = 7  # 50일 → 7일로 변경
```

### Q3. 필터 조건을 비활성화할 수 있나요?

**방법**: `kr/strategy.py` 초기화 시 설정

```python
# kr/strategy.py 파일 수정 (37줄)
enable_filter_check=False  # True → False로 변경
```

또는 **filter_stocks를 비우기**:

```json
{
    "filter_stocks": {},  // ← 비워두면 필터 조건 무시
    "watch_list": [...]
}
```

### Q4. 하락률 상위 3개가 아니라 5개를 매수하고 싶어요

**방법**: `kr/strategy.py` 파일 수정 (278줄)

```python
# 변경 전
top_declining = self.get_top_declining_stocks(count=3)

# 변경 후
top_declining = self.get_top_declining_stocks(count=5)
```

### Q5. 손절률과 목표 수익률을 종목별로 다르게 설정할 수 있나요?

**답변**: 현재 버전에서는 **모든 종목에 동일 설정** 적용됩니다.

종목별 차등 설정을 원하시면 코드 커스터마이징이 필요합니다.

### Q6. 어떤 주식이 올라가면 매수가 작동하나요?

**답변**: `filter_stocks`에 설정된 종목들이 **모두** 전일 대비 상승할 때 매수가 작동합니다.

**현재 기본 설정**:
```json
"filter_stocks": {
    "005930": true,  ← 삼성전자
    "000660": true,  ← SK하이닉스
    "035420": true   ← NAVER
}
```

**작동 조건**:
```
✅ 삼성전자 상승 (+1.2%)
✅ SK하이닉스 상승 (+0.8%)
✅ NAVER 상승 (+2.5%)

→ 모든 필터 종목 상승 → 매수 허용!
```

**매수 불가 케이스**:
```
✅ 삼성전자 상승 (+1.2%)
❌ SK하이닉스 하락 (-0.3%)
✅ NAVER 상승 (+2.5%)

→ 하나라도 하락 → 매수 불가!
```

**로그 메시지**:
```
[INFO] 필터 조건 충족 - 모든 필터 종목 상승 중
[INFO] === 매수 조건 체크 통과 ===
```

---

## 📚 관련 문서

- **[README.md](README.md)**: 시스템 전체 개요
- **[kr/config.py](kr/config.py)**: 한국 주식 설정 파일
- **[kr/strategy.py](kr/strategy.py)**: 한국 주식 매매 전략 코드
- **[kr_stocks_config.json](kr_stocks_config.json)**: 종목 설정 파일

---

## 🆘 문제 해결

### 매수가 실행되지 않을 때

1. **로그 확인**: `trading.log` 파일에서 원인 파악
2. **필터 조건**: filter_stocks가 모두 상승 중인지 확인
3. **예수금**: 매수 가능한 잔고가 있는지 확인
4. **블랙리스트**: `kr_stop_loss_blacklist.json` 파일 확인
5. **시장 시간**: 09:00 - 15:30 (한국 시간) 내인지 확인

### 손절이 작동하지 않을 때

1. **손절률 확인**: `kr/config.py`의 `STOP_LOSS_THRESHOLD` 값 확인
2. **수익률 계산**: 로그에서 현재 수익률 확인
3. **시장 시간**: 매도는 장 마감 30분 전까지만 가능

---

**버전**: v4.7
**최종 업데이트**: 2026-01-31
**작성자**: Claude Code AI Agent
