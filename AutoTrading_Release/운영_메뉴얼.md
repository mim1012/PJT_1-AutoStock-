# 📖 운영 메뉴얼 (완전판)

한국투자증권 자동매매 시스템 v4.7 전체 운영 가이드입니다.

---

## 📑 목차

1. [시스템 개요](#1-시스템-개요)
2. [설치 및 초기 설정](#2-설치-및-초기-설정)
3. [시작 전 검증 시스템](#3-시작-전-검증-시스템) ⭐NEW
4. [실행 모드별 가이드](#4-실행-모드별-가이드)
5. [매매 전략 이해](#5-매매-전략-이해)
6. [설정 변경 가이드](#6-설정-변경-가이드)
7. [모니터링 및 로그](#7-모니터링-및-로그)
8. [트러블슈팅](#8-트러블슈팅)
9. [보안 및 백업](#9-보안-및-백업)
10. [FAQ](#10-faq)

---

## 1. 시스템 개요

### 1-1. 주요 기능

#### 🌍 듀얼 마켓 지원
- **한국 주식 (국장)**: KOSPI, KOSDAQ
- **미국 주식 (미장)**: NASDAQ, NYSE
- **자동 시장 전환**: 시간대별 활성 시장 자동 감지

#### 🤖 자동 매매
- **매수**: 필터 조건 충족 시 하락률 상위 종목 자동 매수
- **매도**: 목표 수익률 달성 또는 손절 기준 도달 시 자동 매도
- **손절 후 재매수 금지**: 손절한 종목 일정 기간 매수 차단

#### 🔒 안전 기능
- **시작 전 검증**: 종목 코드 유효성 자동 확인
- **모의투자 지원**: 실전 전 안전한 테스트
- **24시간 토큰 관리**: 자동 발급/갱신

---

### 1-2. 시스템 구조

```
AutoTrading_Release/
├── common/          # 공통 베이스 클래스
├── kr/              # 한국 주식 전용 모듈
├── us/              # 미국 주식 전용 모듈
├── main.py          # 메인 실행 (미국 단독/듀얼)
├── auto_market_scheduler.py  # 자동 시장 전환 (권장)
├── startup_validator.py  # 시작 전 검증 ⭐NEW
└── 문서들...
```

---

## 2. 설치 및 초기 설정

### 2-1. 시스템 요구사항

- **OS**: Windows 10 이상
- **Python**: 3.8 이상 (3.11 권장)
- **메모리**: 최소 2GB
- **디스크**: 500MB 여유 공간
- **네트워크**: 안정적인 인터넷 필수

---

### 2-2. Python 설치

1. [Python 공식 사이트](https://www.python.org/downloads/) 접속
2. Python 3.11 다운로드
3. 설치 시 **"Add Python to PATH"** 체크 필수!

**확인**:
```bash
python --version
# Python 3.11.x 출력되면 성공
```

---

### 2-3. 패키지 설치

```bash
cd AutoTrading_Release
pip install -r requirements.txt
pip install mojito2
```

**문제 발생 시**:
```bash
pip install --upgrade pip
pip install -r requirements.txt --force-reinstall
```

---

### 2-4. API 키 발급

#### Step 1: 한국투자증권 가입
1. [한국투자증권](https://www.koreainvestment.com/) 접속
2. 계좌 개설 (모의투자 or 실전투자)

#### Step 2: API 포털 접속
1. [API 포털](https://apiportal.koreainvestment.com/) 접속
2. 회원가입 및 로그인

#### Step 3: API 키 발급
1. "APP KEY 발급" 메뉴 선택
2. APP KEY, APP SECRET 발급
3. 안전하게 복사 (한 번만 표시됨!)

---

### 2-5. 환경 변수 설정

#### Step 1: .env 파일 생성
```bash
copy .env.example .env
```

#### Step 2: .env 파일 편집
```env
KIS_APP_KEY=발급받은_APP_KEY
KIS_APP_SECRET=발급받은_APP_SECRET
KIS_ACCOUNT_NUMBER=12345678-01
USE_PAPER_TRADING=True
```

**주의사항**:
- `KIS_ACCOUNT_NUMBER`는 하이픈 포함 (예: 12345678-01)
- 처음에는 반드시 `USE_PAPER_TRADING=True`

---

## 3. 시작 전 검증 시스템 ⭐NEW

### 3-1. 자동 검증 프로세스

시스템 시작 시 자동으로 다음을 확인합니다:

1. **설정 파일 로드**: kr/us_stocks_config.json
2. **종목 코드 검증**: API 호출로 실제 존재 여부 확인
3. **설정 요약 표시**: 손절률, 재매수 금지 등
4. **사용자 확인**: Enter/q 입력 대기

---

### 3-2. 검증 화면 이해

```
================================================================================
🇰🇷 한국 주식 (국장) 설정
================================================================================
📌 거래 모드: 모의투자
📌 손절률: -10.0%
📌 재매수 금지: 50일
📌 목표 수익률: 5.0%

[필터 종목] - 이 종목들이 모두 상승해야 매수 실행
--------------------------------------------------------------------------------
✅ 005930: 확인됨
✅ 000660: 확인됨
❌ 005931: 종목 조회 실패 (존재하지 않거나 API 오류)
```

#### 상태 아이콘
- ✅ **확인됨**: 종목 정상
- ❌ **오류**: 종목 코드 잘못됨 또는 API 오류

---

### 3-3. 오류 발견 시 대처

오류가 있으면 `q`를 입력하여 종료 후:

1. JSON 파일 열기 (메모장)
2. 잘못된 종목 코드 수정 또는 삭제
3. 파일 저장
4. 시스템 재시작

---

## 4. 실행 모드별 가이드

### 4-1. 자동 시장 전환 모드 (권장) ⭐

**실행**:
```bash
start_auto.bat
```

또는

```bash
python auto_market_scheduler.py
```

**특징**:
- 현재 시간에 따라 활성 시장만 자동 모니터링
- 한국 장 시간 → 한국 주식만
- 미국 장 시간 → 미국 주식만
- CPU 효율적, 불필요한 API 호출 없음

**적합한 사용자**:
- 국장/미장 모두 거래
- 24시간 켜두고 싶음
- 자동화 선호

---

### 4-2. 미국 주식 단독 모드

**실행**:
```bash
python main.py
```

**특징**:
- 미국 주식만 거래
- 09:30 - 16:00 ET (22:30/23:30 - 05:00/06:00 KST)

**적합한 사용자**:
- 미국 주식만 거래
- 밤시간 거래 선호

---

### 4-3. 한국 주식 단독 모드

**실행**:
```bash
python main.py --market kr
```

**특징**:
- 한국 주식만 거래
- 09:00 - 15:30 KST

**적합한 사용자**:
- 국장만 거래
- 낮시간 거래 선호

---

### 4-4. 듀얼 마켓 모드

**실행**:
```bash
python main.py --market both
```

**특징**:
- 미국 + 한국 동시 거래
- 두 시장 모두 모니터링 (시간대 무관)

**적합한 사용자**:
- 국장/미장 모두 거래
- 장 시간 구분 필요 없음

---

## 5. 매매 전략 이해

### 5-1. 매수 전략

#### 조건 (모두 충족 필요)
1. **시장 오픈 확인**: 거래 시간 내
2. **필터 조건 통과**: filter_stocks 종목 **모두 상승**
3. **예수금 확인**: 매수 가능한 잔고 있음
4. **하락률 상위 선정**: watch_list에서 하락률 상위 3개
5. **블랙리스트 체크**: 손절 후 재매수 금지 확인
6. **이전 매도가 체크**: 더 낮은 가격에만 재매수

#### 실행
- 하락률 상위 최대 3개 종목 시장가 매수
- 1종목당 투자금: 전체 예수금 / 3

---

### 5-2. 매도 전략

#### 조건 (하나만 충족)
1. **익절**: 수익률 >= 목표 수익률 (기본 5%)
2. **손절**: 수익률 <= 손절 기준 (국장 -10%, 미장 -15%)

#### 실행
- 조건 충족 종목 전량 시장가 매도
- 익절: 매도가 기록 (재매수 방지)
- 손절: 블랙리스트 등록 (재매수 금지)

---

### 5-3. 필터 조건 (국장)

**목적**: 시장이 상승 추세일 때만 매수

**작동**:
```
filter_stocks = ["005930", "000660", "035420"]

1. 삼성전자 현재가 > 전일 종가? → YES
2. SK하이닉스 현재가 > 전일 종가? → YES
3. NAVER 현재가 > 전일 종가? → YES

→ 모두 상승 중 → 매수 허용
```

**하나라도 하락 시**:
```
1. 삼성전자 상승
2. SK하이닉스 하락 ← 이거 하나 때문에
3. NAVER 상승

→ 매수 불가!
```

---

## 6. 설정 변경 가이드

자세한 내용은 **[설정 빠른 참조](설정_빠른_참조.md)** 참조

### 6-1. 자주 변경하는 설정

| 항목 | 파일 | 줄 | 예시 |
|------|------|-----|------|
| 거래 모드 | `.env` | 5 | `USE_PAPER_TRADING=False` |
| 목표 수익률 | `config.py` | 33 | `PROFIT_THRESHOLD = 0.03` |
| 국장 손절률 | `kr/config.py` | 78 | `STOP_LOSS_THRESHOLD = -0.15` |
| 미장 손절률 | `us/config.py` | 90 | `STOP_LOSS_THRESHOLD = -0.10` |
| 국장 종목 | `kr_stocks_config.json` | - | JSON 편집 |
| 미장 종목 | `us_stocks_config.json` | - | JSON 편집 |

---

## 7. 모니터링 및 로그

### 7-1. 로그 파일 위치

**파일**: `trading.log`

### 7-2. 실시간 로그 확인

**PowerShell**:
```powershell
Get-Content trading.log -Wait -Tail 20
```

**명령 프롬프트**:
```cmd
type trading.log
```

---

### 7-3. 로그 레벨 이해

```
[DEBUG] 상세 디버깅 정보
[INFO] 일반 정보 (기본)
[WARNING] 경고 (주의 필요)
[ERROR] 오류 (즉시 확인 필요)
[CRITICAL] 치명적 오류 (시스템 중단)
```

---

### 7-4. 주요 로그 패턴

#### 정상 작동
```
[INFO] === 한국 주식 매수 전략 실행 ===
[INFO] 필터 조건 충족 - 모든 필터 종목 상승 중
[INFO] 매수 주문 실행: 035720 50주 @ 58,000원
[INFO] 2건 매수 실행
```

#### 필터 조건 미충족
```
[INFO] 필터 조건 미충족: 000660 하락 중 (현재: 139000, 전일: 140000)
[INFO] 필터 조건 미충족 → 매수 건너뜀
```

#### 손절 발생
```
[WARNING] 035720: 손절 조건 충족 (-10.50%)
[INFO] 매도 주문 실행: 035720 (손절매)
[INFO] 035720를 블랙리스트에 추가 (50일 재매수 금지)
```

#### 토큰 관련
```
[INFO] [TOKEN_CHECK] 토큰 유효, 브로커 정상
[WARNING] [TOKEN_CHECK] 토큰이 만료되었거나 없음 - 재발급 완료
```

---

### 7-5. 거래 내역 CSV

**위치**: `transaction_logs/kr_trading_log_YYYYMMDD.csv`

**열 구조**:
```csv
timestamp,type,symbol,quantity,price,amount,profit_loss,profit_rate,status,notes
2026-01-31 10:30:00,buy,035720,50,58000,2900000,0,0.0,filled,하락률 상위 매수
2026-01-31 14:30:00,sell,035720,50,60900,3045000,145000,5.0,filled,profit_target_reached
```

---

## 8. 트러블슈팅

### 8-1. 토큰 발급 실패

**증상**:
```
[ERROR] 토큰 발급 실패: 401 Unauthorized
```

**원인**:
1. API 키 잘못됨
2. 24시간 내 재발급 시도
3. 네트워크 문제

**해결**:
1. `.env` 파일의 API 키 확인
2. 24시간 후 재시도
3. 인터넷 연결 확인

---

### 8-2. 주문 실패

**증상**:
```
[ERROR] 주문 실패: 잔고 부족
```

**원인**:
1. 예수금 부족
2. 시장 폐장
3. 종목 코드 오류

**해결**:
1. 계좌 잔고 확인
2. 거래 시간 확인
3. 종목 코드 재확인

---

### 8-3. 모듈 import 오류

**증상**:
```
ModuleNotFoundError: No module named 'mojito2'
```

**해결**:
```bash
pip install mojito2 --force-reinstall
pip install -r requirements.txt --force-reinstall
```

---

### 8-4. 프로그램 갑자기 종료

**원인**:
1. Python 오류
2. 네트워크 끊김
3. API 호출 한도 초과

**해결**:
1. `trading.log` 마지막 줄 확인
2. 인터넷 연결 확인
3. 1분 후 재시작

---

### 8-5. 매수가 실행 안 됨

**체크리스트**:
- [ ] 시장 오픈 시간인가?
- [ ] 필터 종목 모두 상승 중인가?
- [ ] 예수금 충분한가?
- [ ] watch_list에 종목 있는가?
- [ ] 블랙리스트에 없는가?

**로그 확인**:
```
[INFO] 필터 조건 미충족 → 매수 건너뜀
```

---

## 9. 보안 및 백업

### 9-1. 보안 수칙

1. **API 키 관리**
   - `.env` 파일 절대 공유 금지
   - GitHub 업로드 금지
   - 노출 시 즉시 재발급

2. **계좌 정보**
   - 계좌번호 외부 노출 금지
   - 실전 계좌는 별도 관리

3. **네트워크 보안**
   - 공용 Wi-Fi 사용 금지
   - VPN 사용 권장

---

### 9-2. 백업 전략

#### 일일 백업
- `trading.log` 복사
- `transaction_logs/*.csv` 복사
- `*_stop_loss_blacklist.json` 복사

#### 주간 백업
- 전체 폴더 압축
- 외부 저장소에 보관

#### 설정 백업
- `.env` (암호화하여 보관)
- `*_stocks_config.json`
- `config.py`, `kr/config.py`, `us/config.py`

---

## 10. FAQ

### Q1. 모의투자와 실전투자 차이는?

**모의투자**:
- 가상 돈으로 거래
- 실제 시장 데이터 사용
- 안전하게 테스트 가능

**실전투자**:
- 실제 돈으로 거래
- 손실 발생 가능
- 충분한 테스트 후 전환

---

### Q2. 24시간 켜두어야 하나요?

**자동 시장 전환 모드**: 24시간 켜두기 권장
- 국장/미장 시간대 자동 감지
- 폐장 시간엔 대기 모드 (CPU 절약)

**단독 모드**: 해당 시장 거래 시간만 켜도 됨
- 미장: 밤 10시~새벽 6시 (서머타임 고려)
- 국장: 오전 9시~오후 3시30분

---

### Q3. 손절 후 재매수 금지를 해제하려면?

**방법 1**: 블랙리스트 파일 수정
- `kr_stop_loss_blacklist.json` 열기
- 해당 종목 삭제
- 저장 후 재시작

**방법 2**: 쿨다운 기간 단축
- `kr/config.py` 열기
- `STOP_LOSS_COOLDOWN_DAYS = 7` (50 → 7일로)

---

### Q4. 여러 계좌로 동시 운영 가능?

**가능합니다!**

1. 폴더 복사 (AutoTrading_Release_Account1, Account2...)
2. 각 폴더의 `.env` 파일에 다른 계좌 정보 입력
3. 각각 별도 실행

---

### Q5. 수익률은 얼마나 되나요?

**답변**: 개인차가 큽니다.
- 시장 상황
- 종목 선정
- 설정값 (손절률, 목표 수익률)

**권장**:
- 모의투자로 1개월 테스트
- 자신에게 맞는 설정 찾기
- 실전은 소액부터 시작

---

### Q6. 서버 컴퓨터가 필요한가요?

**선택사항**:
- 집 PC 24시간 켜두기 (전기세 고려)
- 클라우드 VM 사용 (AWS, Azure, GCP)
- 라즈베리파이 사용 (저전력)

**권장**: 집 PC로 시작 → 안정적이면 클라우드 전환

---

### Q7. 휴대폰으로도 모니터링 가능?

**방법**:
1. **로그 파일 공유**
   - OneDrive, Google Drive에 로그 폴더 동기화
   - 휴대폰에서 로그 확인

2. **원격 접속**
   - TeamViewer, AnyDesk 등
   - PC 화면 직접 확인

3. **텔레그램 봇** (고급)
   - 봇 연동 (별도 개발 필요)
   - 거래 알림 수신

---

## 📚 관련 문서

- **[빠른 시작 가이드](빠른_시작_가이드.md)** - 5분 안에 시작
- **[설정 빠른 참조](설정_빠른_참조.md)** - 설정 치트시트
- **[국장 매매 설정 가이드](국장_매매_설정_가이드.md)** - 한국 주식 상세
- **[배포 체크리스트](배포_체크리스트.md)** - 배포 전 확인사항

---

## 🆘 지원

### 문서 우선 확인
1. 이 운영 메뉴얼
2. FAQ 섹션
3. 트러블슈팅 섹션

### 문제 지속 시
- GitHub Issues 등록
- `trading.log` 파일 첨부
- 상세한 오류 설명

---

**버전**: v4.7
**최종 업데이트**: 2026-01-31
**페이지 수**: 20+
**난이도**: ⭐⭐⭐ 초중고급 모두
