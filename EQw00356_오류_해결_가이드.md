# 🚨 EQw00356 오류 해결 가이드

## 📋 개요
`rt_cd: 1, msg_cd: EQw00356` 오류는 한국투자증권 API를 사용한 미국 주식 주문 시 발생하는 TR ID 문제와 메소드 사용 오류입니다.

## ⚠️ 문제 원인 분석
EQw00356 오류는 다음과 같은 원인으로 발생합니다:
- 잘못된 exchange 설정
- 미국 주식용 메소드를 사용하지 않음
- TR ID 매핑 오류
- 계좌 설정 문제
- 해외주식 계좌 미개설
- 외화 예수금 부족

## 🛠️ 해결 도구

### 1. 기본 디버깅 도구
```bash
# 기본 디버깅 실행
debug_eqw00356.bat
```

**파일**: `debug_eqw00356_error.py`
- 단계별 디버깅 (브로커 생성 → 잔고 조회 → 현재가 조회 → 주문 시도)
- 국내 주식, 모의투자, 실전투자 순차 테스트
- 상세한 오류 메시지와 해결 방법 제시

### 2. 고급 진단 도구
```bash
# 고급 진단 실행
advanced_eqw00356_fix.bat
```

**파일**: `advanced_eqw00356_fix.py`
- 종합적인 진단 및 자동 수정 기능
- 거래소 설정, 종목 유효성, 주문 메소드별 테스트
- JSON 형태의 진단 보고서 생성
- 시장 시간 확인 및 계좌 권한 검증

### 3. 간단한 테스트 도구
```bash
# 간단한 테스트 실행
simple_eqw00356_test.bat
```

**파일**: `simple_eqw00356_test.py`
- 사용자가 제공한 해결 방법 기반 테스트
- 기본 설정 → 시장가 주문 → 지정가 주문 순차 테스트
- 모의투자 및 국내 주식 테스트 포함

## ✅ 올바른 해결 방법

### 1. 정확한 미국 주식 브로커 설정

```python
import mojito

# ❌ 잘못된 설정
# broker = mojito.KoreaInvestment(exchange="NASD")  # 이것만으로는 부족

# ✅ 올바른 설정 - 모든 파라미터 명시적으로 설정
broker = mojito.KoreaInvestment(
    api_key=key,
    api_secret=secret,
    acc_no=acc_no,
    exchange="NASD",        # 미국 거래소 설정
    mock=False              # 실전투자 시 False, 모의투자 시 True
)
```

### 2. 시장가 주문부터 테스트 (지정가 주문보다 안정적)

```python
# ✅ 먼저 시장가 주문으로 테스트
resp = broker.create_market_buy_order(
    symbol="AAPL",    # 안정적인 대형주로 테스트
    quantity=1        # 소량으로 테스트
)

print(f"응답 코드: {resp['rt_cd']}")
print(f"메시지: {resp.get('msg1', 'N/A')}")

if resp['rt_cd'] == '0':
    print("✅ 시장가 매수 성공!")
    print(f"주문번호: {resp['output']['ODNO']}")
else:
    print("❌ 시장가 매수 실패")
    print(f"오류 메시지: {resp}")
```

### 3. 시장가 주문 성공 후 지정가 주문 시도

```python
# 시장가 주문이 성공하면 지정가 주문 시도
if resp['rt_cd'] == '0':
    # 현재가 조회
    current_price_info = broker.fetch_price("AAPL")
    current_price = float(current_price_info['output']['last'])
    
    # 현재가보다 약간 낮은 가격으로 지정가 매수 주문
    limit_price = round(current_price * 0.99, 2)  # 현재가의 99%
    
    resp_limit = broker.create_limit_buy_order(
        symbol="AAPL",
        price=limit_price,
        quantity=1
    )
    
    print(f"지정가 주문 결과: {resp_limit}")
```

## 🎯 대안 해결책

### 방법 1: 모의투자로 먼저 테스트

```python
# 모의투자 환경에서 테스트
broker_mock = mojito.KoreaInvestment(
    api_key=key,
    api_secret=secret,
    acc_no=acc_no,
    exchange="NASD",
    mock=True  # 모의투자 모드
)

# 모의투자에서 주문 테스트
resp = broker_mock.create_market_buy_order("AAPL", 1)
print(resp)
```

### 방법 2: 국내 주식으로 먼저 테스트

```python
# 국내 주식으로 mojito가 정상 작동하는지 확인
broker_kr = mojito.KoreaInvestment(
    api_key=key,
    api_secret=secret,
    acc_no=acc_no
    # exchange 파라미터 없음 (국내 주식)
)

# 삼성전자 현재가 조회 테스트
kr_price = broker_kr.fetch_price("005930")
print(f"삼성전자 현재가: {kr_price}")
```

## 📋 체크리스트

다음 사항들을 순서대로 확인해보세요:

- [ ] 해외주식 계좌 개설 완료
- [ ] 외화(달러) 예수금 보유
- [ ] API 키/시크릿 정확성
- [ ] 계좌번호 형식 (8자리-2자리)
- [ ] mojito 라이브러리 최신 버전
- [ ] 시장 시간 확인 (미국 장 시간)
- [ ] 모의투자 먼저 테스트

## 🔧 단계별 디버깅 코드

### 1단계: 브로커 객체 생성 확인
```python
print("=== 1단계: 브로커 객체 생성 ===")
try:
    broker = mojito.KoreaInvestment(
        api_key=key,
        api_secret=secret,
        acc_no=acc_no,
        exchange="NASD",
        mock=False
    )
    print("✅ 브로커 객체 생성 성공")
except Exception as e:
    print(f"❌ 브로커 객체 생성 실패: {e}")
    return False
```

### 2단계: 잔고 조회 확인
```python
print("=== 2단계: 잔고 조회 ===")
try:
    balance = broker.fetch_balance()
    print("✅ 잔고 조회 성공")
    print(f"rt_cd: {balance.get('rt_cd', 'N/A')}")
    
    if balance.get('rt_cd') == '0':
        usd_cash = balance['output2'].get('frcr_dncl_amt_2', '0')
        print(f"보유 달러: ${usd_cash}")
    else:
        print(f"❌ 잔고 조회 오류: {balance}")
        return False
except Exception as e:
    print(f"❌ 잔고 조회 실패: {e}")
    return False
```

### 3단계: 현재가 조회 확인
```python
print("=== 3단계: 현재가 조회 ===")
try:
    price_info = broker.fetch_price("AAPL")
    print("✅ 현재가 조회 성공")
    print(f"rt_cd: {price_info.get('rt_cd', 'N/A')}")
    
    if price_info.get('rt_cd') == '0':
        current_price = price_info['output']['last']
        print(f"AAPL 현재가: ${current_price}")
    else:
        print(f"❌ 현재가 조회 오류: {price_info}")
        return False
except Exception as e:
    print(f"❌ 현재가 조회 실패: {e}")
    return False
```

### 4단계: 시장가 주문 시도
```python
print("=== 4단계: 시장가 주문 ===")
try:
    resp = broker.create_market_buy_order("AAPL", 1)
    print("시장가 주문 응답:")
    pprint.pprint(resp)
    
    if resp.get('rt_cd') == '0':
        print("✅ 시장가 주문 성공!")
    else:
        print("❌ 시장가 주문 실패")
        
        # EQw00356 오류 특별 처리
        if resp.get('msg_cd') == 'EQw00356':
            print("\n🔧 EQw00356 오류 특별 해결 방법:")
            print("1. 모의투자로 먼저 테스트해보세요")
            print("2. 계좌 설정을 확인하세요")
            print("3. API 키 권한을 확인하세요")
            print("4. 해외주식 거래 가능 시간인지 확인하세요")
except Exception as e:
    print(f"❌ 시장가 주문 예외: {e}")
```

## 📊 로그 파일

각 도구는 상세한 로그를 생성합니다:
- `debug_eqw00356.log` - 기본 디버깅 로그
- `advanced_eqw00356_fix.log` - 고급 진단 로그
- `eqw00356_diagnosis_report.json` - 진단 보고서

## 🚀 사용 방법

1. **기본 테스트**: `simple_eqw00356_test.bat` 실행
2. **상세 진단**: `debug_eqw00356.bat` 실행
3. **고급 분석**: `advanced_eqw00356_fix.bat` 실행

각 단계에서 발생하는 오류를 확인하고, 제공된 해결 방법을 따라 문제를 해결하세요.

## 📞 추가 지원

문제가 지속되는 경우:
1. 생성된 로그 파일을 확인
2. 진단 보고서 분석
3. 한국투자증권 고객센터 문의
4. mojito 라이브러리 GitHub 이슈 등록

---

**참고**: 이 가이드는 사용자가 제공한 해결 방법을 기반으로 작성되었으며, 실제 환경에 따라 결과가 다를 수 있습니다. 